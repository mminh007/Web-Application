import cv2
import numpy as np
from PIL import Image
import io
import base64


def process_output(image, results):
    results = results[0]
    boxes = results.boxes.xyxy
    class_ids = results.boxes.cls

    _, image_decode = base64.b64decode(image)
    image_decode = Image.open(io.BytesIO(image_decode))
    image_decode = np.array(image_decode)

    image_copy = image_decode.copy()

    for box, class_id in zip(boxes, class_ids):
        color_cls = MAPPING_COLORS.get(class_id)
        x1, y1, x2, y2 = box.tolist()
        cv2.rectangle(image_copy, (int(x1), int(y1)), (int(x2), int(y2)), color_cls, 2)
        cv2.putText(image_copy, str(class_id), (int(x1), int(y1 - 5)), cv2.FONT_HERSHEY_SIMPLEX, 1, color_cls, 2)

    return image_copy


MAPPING_COLORS = {
    0: (190, 161, 141),
    1: (224, 221, 212),
    2: (129, 223, 179),
    3: (178, 196, 220),
    4: (246, 177, 216),
    5: (133, 249, 232),
    6: (171, 242, 231),
    7: (193, 208, 222),
    8: (141, 245, 138),
    9: (228, 149, 157),
    10: (206, 189, 255),
    11: (147, 177, 181),
    12: (208, 225, 170),
    13: (138, 197, 148),
    14: (216, 154, 249),
    15: (174, 218, 145),
    16: (153, 173, 212),
    17: (190, 149, 245),
    18: (128, 156, 143),
    19: (176, 225, 236),
    20: (145, 224, 253),
    21: (241, 192, 176),
    22: (139, 167, 229),
    23: (130, 149, 222),
    24: (151, 130, 225),
    25: (224, 204, 179),
    26: (160, 188, 178),
    27: (164, 255, 215),
    28: (186, 163, 144),
    29: (190, 169, 209),
    30: (192, 172, 163),
    31: (185, 239, 177),
    32: (211, 191, 215),
    33: (227, 217, 189),
    34: (144, 217, 176),
    35: (245, 144, 193),
    36: (156, 139, 235),
    37: (249, 155, 255),
    38: (192, 217, 142),
    39: (150, 153, 191),
    40: (145, 144, 154),
    41: (157, 249, 213),
    42: (221, 208, 141),
    43: (223, 225, 247),
    44: (160, 202, 175),
    45: (248, 140, 246),
    46: (156, 206, 177),
    47: (204, 203, 154),
    48: (179, 181, 133),
    49: (182, 206, 129),
    50: (204, 240, 250),
    51: (232, 152, 170),
    52: (198, 248, 155),
    53: (129, 175, 221),
    54: (235, 250, 140),
    55: (204, 222, 148),
    56: (136, 147, 249),
    57: (179, 173, 168),
    58: (143, 249, 200),
    59: (183, 220, 206),
    60: (220, 170, 223),
    61: (198, 179, 193),
    62: (152, 237, 211),
    63: (198, 230, 253),
    64: (157, 132, 180),
    65: (164, 206, 221),
    66: (241, 134, 175),
    67: (198, 151, 157),
    68: (158, 230, 137),
    69: (204, 168, 220),
    70: (151, 134, 164),
    71: (151, 248, 206),
    72: (233, 218, 201),
    73: (241, 128, 203),
    74: (176, 224, 201),
    75: (147, 171, 143),
    76: (190, 242, 214),
    77: (252, 192, 134),
    78: (253, 230, 190),
    79: (195, 154, 151)
}